<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validator Charts</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.7.2/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.5.0/Recharts.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        window.onload = function() {
            const { useState, useEffect } = React;
            const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

            const chartConfigs = [
                {
                    id: 'chart1',
                    title: 'Performance Metrics',
                    metrics: ['avg_mev_per_block', 'avg_priority_fees_per_block', 'avg_rewards_per_block', 'avg_signature_fees_per_block', 'stake_percentage']
                },
                {
                    id: 'chart2',
                    title: 'Rewards and Fees',
                    metrics: ['commission', 'mev_earned', 'mev_to_validator', 'rewards', 'skip_rate', 'total_block_rewards_after_burn', 'total_block_rewards_before_burn', 'validator_priority_fees', 'validator_signature_fees', 'vote_cost']
                },
                {
                    id: 'chart3',
                    title: 'Block Production',
                    metrics: ['avg_stake_per_leader_slot', 'avg_user_tx_per_block', 'avg_vote_tx_per_block', 'blocks_produced', 'leader_slots', 'mev_commission']
                },
                {
                    id: 'chart4',
                    title: 'Stake and Activity',
                    metrics: ['activated_stake', 'avg_tx_per_block', 'epoch_credits', 'signatures', 'tx_included_in_blocks', 'user_tx_included_in_blocks', 'vote_tx_included_in_blocks', 'votes_cast']
                },
                {
                    id: 'chart5',
                    title: 'Compute Units',
                    metrics: ['avg_cu_per_block']
                }
            ];

            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#008000', '#800080',
                '#FF00FF', '#00FFFF', '#FFD700', '#00FF00', '#FF1493', '#1E90FF', '#FF4500', '#2E8B57'
            ];

            const ValidatorCharts = ({ identityPubkey }) => {
                const [data, setData] = React.useState([]);

                React.useEffect(() => {
                    const fetchData = async () => {
                        try {
                            const response = await fetch(`https://api.trillium.so/validator_rewards/${identityPubkey}`);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            const jsonData = await response.json();
                            console.log('API Response:', jsonData);  // Log the API response
                            setData(jsonData);
                        } catch (error) {
                            console.error("Fetching data failed:", error);
                        }
                    };

                    fetchData();
                }, [identityPubkey]);

                const renderChart = (config) => {
                    const availableMetrics = config.metrics.filter(metric => 
                        data.length > 0 && metric in data[0]
                    );
                    
                    console.log(`Available metrics for ${config.title}:`, availableMetrics);

                    return React.createElement('div', { key: config.id, className: 'chart-container' },
                        React.createElement('h2', null, config.title),
                        availableMetrics.length > 0 ?
                            React.createElement(ResponsiveContainer, { width: '100%', height: 400 },
                                React.createElement(LineChart, { data: data },
                                    React.createElement(CartesianGrid, { strokeDasharray: '3 3' }),
                                    React.createElement(XAxis, { 
                                        dataKey: 'epoch',
                                        reversed: true,
                                        tickCount: 10,
                                        domain: ['dataMin', 'dataMax']
                                    }),
                                    React.createElement(YAxis),
                                    React.createElement(Tooltip),
                                    React.createElement(Legend),
                                    availableMetrics.map((metric, index) =>
                                        React.createElement(Line, {
                                            key: metric,
                                            type: 'monotone',
                                            dataKey: metric,
                                            name: metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                            stroke: colors[index % colors.length],
                                            activeDot: { r: 8 }
                                        })
                                    )
                                )
                            )
                        : React.createElement('p', null, 'No data available for this chart')
                    );
                };

                return React.createElement('div', { className: 'validator-charts' },
                    React.createElement('h1', null, `Validator Charts for ${identityPubkey}`),
                    chartConfigs.map(renderChart)
                );
            };

            ReactDOM.render(
                React.createElement(ValidatorCharts, { identityPubkey: "{{ pubkey }}" }),
                document.getElementById('root')
            );
        };
    </script>
</body>
</html>